#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <stdint.h>

// rgb of a pixel
typedef struct {
    unsigned char r;
    unsigned char g;
    unsigned char b;
} pixel_t;

// image info with width, height and pixels
typedef struct {
    int w, h;
    pixel_t *px;
    unsigned char *head;
    int header; // header size
} image_t;

// xor shift 64
uint64_t xorshift64(uint64_t x) {
    x ^= x << 13;
	x ^= x >> 7;
	x ^= x << 17;
	return x;
}

// parse bmp image
image_t parse_bmp(char* fname) {
    unsigned char *rgb;
    image_t x;

    FILE *tempfile = fopen(fname, "rb");
    unsigned char* tmp = malloc(16 * sizeof(unsigned char));
    fread(tmp, sizeof(unsigned char), 16, tempfile);
    x.header = tmp[11] * 256 + tmp[10];
    fclose(tempfile);

    FILE *file = fopen(fname, "rb");
    printf("Header: %d\n", x.header);
    x.head=malloc(x.header * sizeof(unsigned char));
    fread(x.head, sizeof(unsigned char), x.header, file);
    x.w = x.head[19] * 256 + x.head[18];
    x.h = x.head[23] * 256 + x.head[22];

    fseek(file, x.header, SEEK_SET);
    x.px = calloc(x.w * x.h * 3, sizeof(unsigned char));
    rgb = calloc(3, sizeof(unsigned char));
    for(int i = 0; i < x.w * x.h; i++) {
        fread(rgb, 3, 1, file);
        x.px[i].b = rgb[0];
        x.px[i].g = rgb[1];
        x.px[i].r = rgb[2];
    }
    free(rgb);
    fclose(file);
    return x;
}

// write and save an image
void save_bmp(char* output, image_t x) {
    FILE* out = fopen(output, "wb");
    fwrite(x.head, sizeof(unsigned char), x.header, out);
    fseek(out, x.header, SEEK_SET);
    for(int i = 0; i < x.w * x.h; i++)
    {
        fwrite(&x.px[i].b, sizeof(unsigned char), 1, out);
        fwrite(&x.px[i].g, sizeof(unsigned char), 1, out);
        fwrite(&x.px[i].r, sizeof(unsigned char), 1, out);
    }
    fclose(out);
}

// Image decryption algorithm
image_t decrypt_bmp(image_t x) {
	uint64_t key1 = 123;
    uint64_t *a = calloc(x.w * x.h * 2, sizeof(uint64_t));

    // xorshift
    for(int i = 0; i < 2*x.w*x.h; i++)
    {
        key1 = xorshift64(key1);
        a[i] = key1;
    }

    unsigned int *v, r;
    v = calloc(x.w * x.h,sizeof(unsigned int));

    for(int i = 0; i < x.w*x.h; i++) v[i]=i;

    for(int i = x.w*x.h-1; i>=1; i--) {
        r=a[i]%(i+1);
        int tmp = v[r];
        v[r] = v[i];
        v[i] = tmp;
    }

    pixel_t *old;
    old = calloc(x.w*x.h*3, sizeof(unsigned char));
    old[0].r = x.px[0].r^(((a[x.w*x.h]>>8)>>8)&255);
    old[0].g = 1^x.px[0].g^((a[x.w*x.h]>>8)&255);
    old[0].b = 0x41^x.px[0].b^(a[x.w*x.h]&255);
	for(int i=1; i<x.w*x.h; i++) {
		old[i].r=x.px[i-1].r^x.px[i].r^(((a[x.w*x.h+i]>>8)>>8)&255);
		old[i].g=x.px[i-1].g^x.px[i].g^((a[x.w*x.h+i]>>8)&255);
		old[i].b=x.px[i-1].b^x.px[i].b^(a[x.w*x.h+i]&255);
	}

    // Reverse encryption
    unsigned int *vp = calloc(x.w*x.h, sizeof(unsigned int));
    for(int i = 0; i < x.w*x.h; i++) vp[v[i]] = i;
    for(int i = 0; i < x.w*x.h; i++) x.px[i] = old[vp[vp[i]]];
    
    free(old);
    free(v);
    free(a);
    free(vp);
    
    return x;
}

int main(int argc, char *argv[]) {
	image_t x = parse_bmp("flag.enc.bmp");
	char decrypted[] = "flag_decrypted.bmp";
	x = decrypt_bmp(x);
	save_bmp(decrypted, x);
}